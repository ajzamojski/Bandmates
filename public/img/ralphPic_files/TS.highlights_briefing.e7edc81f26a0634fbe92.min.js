webpackJsonp([252],{2747:function(e,i){!function(){"use strict";TS.registerModule("highlights_briefing",{sli_recaps_debug_group:null,updated_sig:new signals.Signal,$briefing_header:null,$briefing_view:null,last_request_id:null,onStart:function(){TS.client&&(TS.client.ui.unread.started_sig.add(r),TS.client.unread.switched_away_sig.add(p),TS.channels.switched_sig.add(C),TS.groups.switched_sig.add(C),TS.mpims.switched_sig.add(C),TS.ims.switched_sig.add(C),TS.client.threads.switched_sig.add(y),TS.channels.marked_sig.add(P),TS.groups.marked_sig.add(P),TS.channels.message_changed_sig.add(W),TS.groups.message_changed_sig.add(W),TS.channels.message_removed_sig.add(U),TS.groups.message_removed_sig.add(U),TS.pins.pinned_status_changed_sig.add(L),TS.client.highlights.feedback_submitted_sig.add(H),TS.experiment.loadUserAssignments().then(function(){TS.highlights_briefing.sli_recaps_debug_group=TS.experiment.getGroup("sli_recaps_debug")}))},showBriefing:function(){e.removeClass("hidden"),t.toggleClass("hidden",!a.expanded)},hideBriefing:function(){e.addClass("hidden"),t.addClass("hidden")},clogBackButton:function(){var e,i=_.get(a,["last_jump","model_ob_id"]),n=_.get(a,["last_jump","ts"]),t={channel_id:i,channel_type:i[0]||"",message_timestamp:n},s=TS.client.highlights.getHighlight(i,n);s&&(t.request_id=s.request_id,e=s.cached_request_id),e&&(t.cached_request_id=e),TS.clog.track("BRIEFING_BACK_TO_BRIEFING",t)},jumpToMessageInChannel:function(e,i){O(e,i)},setUnreadPointOnMessage:function(e){e=String(e);var i=$('.sli_briefing__message ts-message[data-ts="'+e+'"]');if(i.length){var n=i.data("model-ob-id");TS.shared.markReadMsg(n,e,TS.model.marked_reasons.back),TS.client.markLastReadsWithAPI(),P(TS.shared.getModelObById(n))}},getMessageFromCache:function(e,i){return _.get(s,[e,i],null)}});var e=null,i=null,n=null,t=null,s={},a={expanded:!1,scroll_top:0,last_jump:{ts:null,model_ob_id:null},show_briefing_back_button:!1,last_open_ts:null,loading:!0},d={},r=function(){TS.model.team.plan&&((a.show_briefing_back_button||_.get(a,["last_jump","model_ob_id"]))&&x(),a.briefing_opens_count=TS.storage.fetchBriefingOpensCount(),a.loading=!0,g(),TS.api.call("highlights.briefing").then(l).then(o).catch(function(e){TS.error("A call to highlights.briefing failed:"),TS.logError(e,"Highlights in All Unreads either failed to render or got an error from the API"),f(null,0,!1,!0)}),I())},l=function(e){var i={};return _.get(e,"data.messages.length")&&(e.data.messages=_.map(e.data.messages,function(e){var n=e.channel_id,t=TS.utility.msgs.processImsg(e,n);t.channel_id=n;var s={};return s.show_recap=!0,s.score=e.score,s.feedback_options=e.feedback_options,s.request_id=e.request_id,s.cached_request_id=e.cached_request_id,s.justification=e.justification,i[n]=i[n]||{},i[n][e.ts]=s,t}),TS.client.highlights.addHighlights(i)),e},g=function(){$("#unread_msgs_div").before(TS.templates.sli_briefing({show_onboarding:a.briefing_opens_count<3})),$("#unread_msgs_scroller_div").prepend(TS.templates.sli_briefing_header())},o=function(e){if(TS.highlights_briefing.last_request_id=e.request_id,a.loading=!1,null!==a.last_open_ts&&a.last_open_ts<Date.now()-9e5&&(a.expanded=!1),_.get(e,"data.messages.length")){var r=_.groupBy(e.data.messages,"channel_id"),l=_(r).map(function(e,i){var n=TS.shared.getModelObById(i),t=TS.shared.getTypeForModelOb(n),s=TS.templates.builders.buildStarWithTip(t,n),a={channel:n,star:new Handlebars.SafeString(s),messages:_(e).map(h).compact().value()};return a.messages.length?a:null}).compact().value();l.length&&(m(e.data.messages),i.find(".sli_briefing_view__messages").html(TS.templates.sli_briefing_message_view({groups:l})))}else s={};e.data.headline?(d={header:TS.format.formatWithOptions(e.data.headline.header||"","",{no_linking:!0}),subheader:TS.format.formatWithOptions(e.data.headline.subheader||"","",{no_linking:!0})},u(e.data.headline.users)):d={header:"",subheader:""};var g=b();if(a.expanded&&g)E(!1);else if(a.expanded&&!g)a.expanded=!1,n.removeClass("hidden"),i.addClass("hidden"),t.addClass("hidden"),f(null,0,!0);else{var o=k();f(o,b())}var c=_.get(a,["last_jump","model_ob_id"]),p=_.get(a,["last_jump","ts"]);_.get(s,[c,p])&&(a.scroll_top=0,a.last_jump.ts=null,a.last_jump.model_ob_id=null),g&&(a.briefing_opens_count+=1,TS.storage.storeBriefingOpensCount(a.briefing_opens_count)),TS.highlights_briefing.updated_sig.dispatch()},c=function(e){var i=TS.shared.getModelObById(e.channel_id),n=$(TS.templates.builders.msgs.buildHTML({msg:e,model_ob:i,enable_slack_action_links:!0,container_id:"sli_briefing",prev_msg:null,briefing:!0}));return(e.pinned_to&&e.pinned_to.length||_.get(e,"file.pinned_to.length"))&&n.removeClass("is_pinned"),n.addClass("is_sli_briefing"),n[0].outerHTML},h=function(e){var i=TS.client.highlights.getHighlight(e.channel_id,e.ts);if(i.feedback&&"positive"!==i.feedback)return null;var n=w(i.feedback),t=_.map(i.feedback_options.negative,function(e){return _.assign({},e,{text:new Handlebars.SafeString(TS.format.formatWithOptions(e.text,null,{no_linking:!0}))})});return{message_markup:c(e),message:e,justification:i.justification,feedback_class:n,negative_feedback_options:t}},f=function(e,i,t,s){e&&i?(n.removeClass("sli_briefing_preview--loading").addClass("sli_briefing_preview--has_briefings"),n.find('[data-js="sli_briefing_preview_title"]').html(e.header),a.briefing_opens_count>=3&&n.find('[data-js="sli_briefing_preview_description"]').html(e.subheader),n.find('[data-js="sli_briefing_preview_action"]').removeClass("hidden"),a.briefing_opens_count>=3&&n.find('[data-js="sli_briefing_preview_facepile"]').removeClass("hidden")):t?(n.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty"),n.find('[data-js="sli_briefing_preview_title"]').text(TS.i18n.t("Done and done","highlights")()),n.find('[data-js="sli_briefing_preview_description"]').text(TS.i18n.t("That’s it for the highlights! The rest of your unreads are below.","highlights")()),n.find('[data-js="sli_briefing_preview_action"]').addClass("hidden"),n.find('[data-js="sli_briefing_preview_facepile"]').addClass("hidden")):s?(n.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty"),n.find('[data-js="sli_briefing_preview_title"]').removeClass("small_bottom_margin").addClass("error no_bottom_margin").text(TS.i18n.t("Couldn’t load highlights","highlights")()),n.find('[data-js="sli_briefing_preview_description"]').addClass("hidden"),n.find('[data-js="sli_briefing_preview_action"]').addClass("hidden")):(n.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty"),n.find('[data-js="sli_briefing_preview_title"]').text(TS.i18n.t("No new highlights","highlights")()),n.find('[data-js="sli_briefing_preview_description"]').text(TS.i18n.t("But we’ll keep an ear to the ground.","highlights")()),n.find('[data-js="sli_briefing_preview_action"]').addClass("hidden")),TS.highlights_briefing.updated_sig.dispatch()},u=function(e){var i=_.map(e,function(e){var i=TS.members.getMemberById(e);return TS.templates.builders.makeMemberPreviewLinkImage(i,32,!1,!0,!0,!0)}).join("");n.find('[data-js="sli_briefing_preview_facepile"]').html(i)},m=function(e){s={},_.forEach(e,function(e){s[e.channel_id]=s[e.channel_id]||{},s[e.channel_id][e.ts]=e})},p=function(){TS.model.team.plan&&(F(),e=null,i=null,n=null,t=null,TS.highlights_briefing.$briefing_header=null,TS.highlights_briefing.$briefing_view=null,TS.highlights_briefing.last_request_id=null,d=null,a.last_open_ts=Date.now())},b=function(){return _.reduce(s,function(e,i,n){return e+v(n)},0)},v=function(e){return _.reduce(s[e],function(e,i){return S(i)?e+1:e},0)},T=function(){return _(s).flatMap(function(e){return _.map(e,function(e){return S(e)?e:null})}).compact().value()},S=function(e){var i=TS.client.highlights.getHighlight(e.channel_id,e.ts)||{};return!(e._removed||"dismiss"===i.feedback||i.left_feedback)},k=function(){return d},w=function(e){return"negative"===e?"gave_negative_feedback":"positive"===e?"gave_positive_feedback":"dismiss"===e?"sli_briefing__feedback--dismiss":""},C=function(){TS.model.active_cid===_.get(a,["last_jump","model_ob_id"])&&a.show_briefing_back_button?j():a.last_jump&&a.show_briefing_back_button&&x()},y=function(){TS.model.team.plan&&a.last_jump&&a.show_briefing_back_button&&x()},j=function(){$(".sli_briefing__channel_back_button").removeClass("hidden"),$("#messages_unread_status").addClass("sli_briefing--has_back_button")},x=function(){$(".sli_briefing__channel_back_button").addClass("hidden"),$("#messages_unread_status").removeClass("sli_briefing--has_back_button"),a.show_briefing_back_button=!1},q=function(e,i,n){if("dismiss"===e){var t={request_id:TS.highlights_briefing.last_request_id,message_timestamp:i,channel_id:n,channel_type:n[0]||""},s=TS.client.highlights.getHighlight(n,i),a=s.cached_request_id;a&&(t.cached_request_id=a),TS.clog.track("MSG_BRIEFING_DISMISS",t)}},I=function(){e=$("#sli_briefing"),i=$("[data-js=sli_briefing_view]"),n=$('[data-js="sli_briefing_preview_container"]'),t=$('[data-js="sli_briefing_header"]'),TS.highlights_briefing.$briefing_header=t,TS.highlights_briefing.$briefing_view=i,e.on("click",".sli_briefing__message ts-message, .sli_briefing_target",function(e){if(!(!$(e.target).is("ts-message, .message_content, .message_body, .message_content_header_left, .sli_briefing_target, .comment, .rxn_panel")&&!$(e.target).parents(".message_body").length||$(e.target).parents(".msg_inline_file_preview_toggler").length||$(e.target).is("a")&&$(e.target).closest(".message_body").length||$(e.target).closest(".attachment_media").length)){var i=$(this).is("ts-message")?$(this):$(this).parents("ts-message"),n=i.data("ts")+"",t=i.data("model-ob-id")+"";O(t,n)}}),e.on("click",".sli_briefing__channel_link .channel_link",function(e){var i=$(e.target).data("channel-id");"G"===i[0]&&TS.groups.displayGroup({id:i})}),e.on("click",'[data-js="sli_briefing_preview"]',function(){if(!a.loading){a.expanded=!0,E(!0);var e={request_id:TS.highlights_briefing.last_request_id},i=_.keys(s)[0],n=_.keys(_.get(s,[i]))[0],t=TS.client.highlights.getHighlight(i,n),d=t.cached_request_id;d&&(e.cached_request_id=d),TS.clog.track("BRIEFING_REVEAL",e),TS.highlights_briefing.updated_sig.dispatch()}}),t.off("click").on("click",'[data-js="sli_briefing_header_dismiss_all"]',function(){a.expanded=!1,M();var e=T(),i=_.map(e,function(e){return{channel_id:e.channel_id,ts:e.ts}});TS.api.call("highlights.dismissAll",{request_id:TS.highlights_briefing.last_request_id,source:"briefing",messages:JSON.stringify(i)}).catch(function(e){TS.error(e)})}),e.on("click",'[data-js="sli_briefing_feedback_item"] a',function(e){e.preventDefault();var i=($(e.target).closest(".sli_briefing__feedback_leavebehind").data("feedback-for-cache-id")||"").split("-"),n=Number($(e.target).closest("li").data("index")),t=i[0],s=i[1];TS.client.highlights.setNegativeFeedbackForHighlight(t,s,n,"briefing")}),e.on("click","[data-feedback]",function(e){e.preventDefault();var i=$(e.target).data("feedback"),n=$(e.target).closest(".sli_briefing__message"),t=(n.data("cache-id")||"").split("-"),s=t[0],a=t[1];TS.client.highlights.setDefaultFeedbackForHighlight(s,a,{feedback:i},"briefing"),$("#ts_tip_float_floater .ts_tip_tip").text(TS.i18n.t("Thank you!","highlights")())})},H=function(e){TS.model.unread_view_is_showing&&_.each(e,function(e,i){_.each(e,function(e,n){if(s[i]&&s[i][n]){var t=$('[data-cache-id="'+i+"-"+n+'"]');t.length&&B(t,i,n,e)}})})},B=function(e,i,n,t){"dismiss"===t.feedback||!t.is_leaving_feedback&&t.left_feedback?(A(e,i,function(){R()&&G()}),q("dismiss",n,i)):"negative"===t.feedback&&t.is_leaving_feedback?(e.find("ts-message").addClass("hidden"),e.addClass("gave_negative_feedback"),e.find('[data-feedback="negative"]').addClass("sli_briefing__feedback_control--pulse"),$('[data-feedback-for-cache-id="'+i+"-"+n+'"]').removeClass("hidden")):"positive"===t.feedback&&(e.addClass("gave_positive_feedback"),e.find('[data-feedback="positive"]').addClass("sli_briefing__feedback_control--pulse"))},E=function(n){var s=e.outerHeight(),a=$('[data-js="sli_briefing_preview_container"]');if(i.removeClass("hidden"),t.removeClass("hidden"),TS.client.ui.checkInlineImgsAndIframes("unread"),n){a.css({height:0,"margin-top":(TS.environment.supports_sticky_position?-61:0)+"px"});var _=e.outerHeight();e.css({height:s,"padding-top":"81px","margin-top":"-61px"}),e.animate({height:_+61},300,function(){e.css({height:"auto","margin-top":"","padding-top":TS.environment.supports_sticky_position?"81px":""}),i.find(".sli_briefing__channel, .sli_briefing_view__footer").each(function(e,i){setTimeout(function(){$(i).css("opacity",1)},100*e+200)}),TS.model.prefs.seen_highlights_warm_welcome||(setTimeout(function(){TS.coachmark.start(TS.coachmarks.coachmarks.highlights_feedback,!0)},800),TS.model.prefs.seen_highlights_warm_welcome=!0,TS.prefs.setPrefByAPI({name:"seen_highlights_warm_welcome",value:!0}),TS.clog.track("PREF_USER_CLIENT_UPDATE",{updated_user_client_prefs:{seen_highlights_warm_welcome:"true"}})),TS.highlights_briefing.updated_sig.dispatch()})}else a.css({transition:"none",height:0,"margin-top":(TS.environment.supports_sticky_position?-61:0)+"px"}),t.css("transition","none"),i.find(".sli_briefing__channel, .sli_briefing_view__footer").css("opacity",1),e.css({height:"auto","margin-top":"","padding-top":TS.environment.supports_sticky_position?"81px":""});a.addClass("go-away"),t.addClass("expand"),n||setTimeout(function(){t.css("transition",""),a.css("transition","")},0)},M=function(){var n=$('[data-js="sli_briefing_preview_container"]');t.removeClass("expand").addClass("go-away");var s=e.outerHeight();i.css({opacity:0,"pointer-events":"none"}),f(null,0,!0);e.css({height:s,"margin-top":TS.environment.supports_sticky_position?"-61px":""}),e.animate({height:166},300,function(){TS.highlights_briefing.updated_sig.dispatch()}),n.css({transition:"none",transform:"translateY(118px)"}),setTimeout(function(){n.css({transition:"",transform:"translateY(0)",opacity:1,"pointer-events":""})},0)},F=function(){e.off("click"),t.off("click")},O=function(e,i){var n,t,s=TS.client.highlights.getHighlight(e,i);n=s.request_id,t=s.cached_request_id,a.scroll_top=TS.client.ui.unread.$scroller.scrollTop(),a.last_jump={ts:i,model_ob_id:e},a.show_briefing_back_button=!0,TS.client.ui.tryToJump(e,i);var _={channel_id:e,channel_type:e[0]||"",message_timestamp:i,request_id:n};t&&(_.cached_request_id=t),TS.clog.track("BRIEFING_JUMP_TO_CHANNEL",_)},A=function(e,i,n){0===v(i)?N(e.closest(".sli_briefing__channel"),n):(e.addClass(w("dismiss")),setTimeout(function(){e.css({transition:"margin-bottom 0.3s","margin-bottom":0}),e.animate({height:0},300,function(){var t=e.parents('.sli_briefing__channel[data-channel-id="'+i+'"]');e.remove(),D(i)&&(t.css({transition:"opacity 0.2s",opacity:.5}),t.find(".sli_briefing__channel_link .star").css("pointer-events","none")),n&&n()})},300))},N=function(e,i){e.addClass("dismiss"),setTimeout(function(){e.css({transition:"margin-bottom 0.3s","margin-bottom":0}),e.animate({height:0},300,function(){e.remove(),i&&i()}),b()||$(".sli_briefing_view__footer").css("opacity",0)},300)},D=function(e){return _.every(s[e],function(i,n){var t=TS.client.highlights.getHighlight(e,n);return!t||"dismiss"===t.feedback})},R=function(){return _.every(s,function(e,i){return _.every(s[i],function(e,n){var t=TS.client.highlights.getHighlight(i,n);return!t||("dismiss"===t.feedback||!0===t.left_feedback)})})},G=function(){e.replaceWith(TS.templates.sli_briefing()),t.addClass("hidden"),I(),f(null,0,!0),a.expanded=!1},P=function(e){TS.model.team.plan&&TS.model.unread_view_is_showing&&e&&s&&!_.isEmpty(s)&&s[e.id]&&_.each(s[e.id],function(i,n){n<e.last_read&&!i._removed&&TS.client.highlights.setDefaultFeedbackForHighlight(e.id,n,{feedback:"dismiss"},"briefing-mark-as-read")})},L=function(e){TS.model.team.plan&&TS.model.unread_view_is_showing&&e&&s&&!_.isEmpty(s)&&s[e.id]&&_.each(s[e.id],function(i,n){var t=$('.sli_briefing__message[data-cache-id="'+e.id+"-"+n+'"]');if(t.length){var s=t.find("ts-message");s.hasClass("is_pinned")&&s.removeClass("is_pinned")}})},W=function(e,i,n){if(TS.model.unread_view_is_showing&&TS.model.team.plan&&s&&!_.isEmpty(s)&&s[e.id]&&s[e.id][i.ts]&&(_.includes(n,"text")||_.includes(n,"reply_count"))){var t=_.assign({},i,{channel_id:e.id});s[e.id][i.ts]=t;var a=$('.sli_briefing__message[data-cache-id="'+e.id+"-"+i.ts+'"]');if(a.length){a.find("ts-message").replaceWith(c(t))}}},U=function(e,i){TS.model.unread_view_is_showing&&TS.model.team.plan&&s&&!_.isEmpty(s)&&s[e.id]&&s[e.id][i.ts]&&TS.client.highlights.setDefaultFeedbackForHighlight(e.id,i.ts,{feedback:"dismiss"})}}()}},[2747]);