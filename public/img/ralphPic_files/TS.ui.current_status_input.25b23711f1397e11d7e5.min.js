webpackJsonp([301],{3004:function(t,e){!function(){"use strict";TS.registerComponent("ui.CurrentStatusInput",{_constructor:function(t){this._onSave=t.onSave,this._onEscape=t.onEscape,this._onError=t.onError,this._$container=t.$parent.find(".current_status_input_container").addBack(".current_status_input_container"),this._$emoji_input=t.$parent.find('[name="status_emoji"]'),this._$inline_saver=t.$parent.find(".current_status_inline_saver"),this._$input=t.$parent.find(".current_status_input"),this._$action_buttons=t.$parent.find(".current_status_action_buttons"),this._$cancel_button=this._$action_buttons.find(".current_status_cancel_button"),this._$save_button=this._$action_buttons.find(".current_status_save_button"),this._$status_emoji_picker=t.$parent.find(".current_status_emoji_picker"),this._$status_clear_icon=t.$parent.find(".status_clear_icon"),this._$status_clear_icon_wrap=t.$parent.find(".status_clear_icon_wrap"),this._$presets_list=t.$parent.find(".current_status_presets"),this._has_form_context=t.has_form_context,this._has_presets_menu=t.has_presets_menu,this._preset_index=t.preset_index,this._is_preset_editor=_.isNumber(this._preset_index),this._selected_emoji=this._getOriginalStatus().emoji,this._bindFunctions(),this._bindEvents(),this._toggleStatusClearIcon(),TS.boot_data.feature_texty_takes_over?this._startTexty():this._startTabComplete(),TS.ui.validation.validate(this._$input)},destroy:function(){this._$input&&(TS.boot_data.feature_texty_takes_over?TS.utility.contenteditable.unload(this._$input):this._$input.TS_tabComplete("destroy")),this._unbindEvents(),this._$container=null,this._$emoji_input=null,this._$inline_saver=null,this._$input=null,this._$action_buttons=null,this._$cancel_button=null,this._$save_button=null,this._$status_clear_icon=null,this._$status_clear_icon_wrap=null,this._$status_emoji_picker=null,this._$presets_list=null,this._has_form_context=null,this._has_presets_menu=null,this._selected_emoji=null,this._preset_index=null,this._is_preset_editor=null,this._onSave=null,this._onEscape=null,this._onError=null},focus:function(){this._$input&&this._$input.length&&TS.utility.contenteditable.setCursorAtEnd(this._$input)},getEscapedInputText:function(){return _.escape(TS.emoji.maybeGetCanonicalEmojiString(TS.utility.contenteditable.value(this._$input).replace(/\t/g," ").trim()))},hasText:function(){return!TS.utility.contenteditable.isEmpty(this._$input,!0)},hasNewText:function(){return this.getEscapedInputText()!==this._getOriginalStatus().text},isEdited:function(){return this.hasNewText()||this._selected_emoji!==this._getOriginalStatus().emoji},isSaveable:function(){return this.isEdited()},onEmojiSelected:function(t){t=t||"",this._selectEmoji(t),this._toggleActionButtons(),this._toggleStatusClearIcon(),this.focus()},onTabComplete:function(t,e){TS.utility.populateInput(this._$input,t,e),TS.ui.validation.validate(this._$input)},_bindFunctions:function(){this._onFocus=this._onFocus.bind(this),this._onCancel=this._onCancel.bind(this),this._onKeydown=this._onKeydown.bind(this),this._onKeyup=this._onKeyup.bind(this),this._onBodyClick=this._onBodyClick.bind(this),this.clearCurrentStatus=this.clearCurrentStatus.bind(this),this._openEmojiPicker=this._openEmojiPicker.bind(this),this._presetChosen=this._presetChosen.bind(this),this._editCurrentStatus=this._editCurrentStatus.bind(this),this.onEmojiSelected=this.onEmojiSelected.bind(this),this.onTabComplete=this.onTabComplete.bind(this)},_bindEvents:function(){TS.boot_data.feature_texty_takes_over||this._$input.on("focus.ui_current_status_input",this._onFocus),this._$input.on("keydown.ui_current_status_input",this._onKeydown),this._$input.on("keyup.ui_current_status_input",this._onKeyup),this._$status_emoji_picker.on("click.ui_current_status_input",this._openEmojiPicker),this._$status_clear_icon.on("click.ui_current_status_input",this.clearCurrentStatus),this._$cancel_button.on("click.ui_current_status_input",this._onCancel),this._$save_button.on("click.ui_current_status_input",this._editCurrentStatus),this._has_presets_menu||this._$presets_list.on("click.ui_current_status_input",".current_status_preset_option",this._presetChosen)},_unbindEvents:function(){this._$input&&this._$input.off(".ui_current_status_input"),this._$status_clear_icon&&this._$status_clear_icon.off(".ui_current_status_input"),this._has_presets_menu||this._$presets_list.off(".ui_current_status_input"),this._$status_emoji_picker&&this._$status_emoji_picker.length&&this._$status_emoji_picker.off(".ui_current_status_input"),this._$cancel_button&&this._$cancel_button.length&&this._$cancel_button.off(".ui_current_status_input"),this._$save_button&&this._$save_button.length&&this._$save_button.off(".ui_current_status_input"),this._maybeRemoveBodyClickHandler()},_getOriginalStatus:function(){return{emoji:this._is_preset_editor?TS.model.team.prefs.custom_status_presets[this._preset_index][0]:TS.members.getMemberCurrentStatus(TS.model.user).emoji,text:this._is_preset_editor?TS.model.team.prefs.custom_status_presets[this._preset_index][1]:TS.members.getMemberCurrentStatus(TS.model.user).text}},_selectEmoji:function(t){this._selected_emoji=t||"",this._$emoji_input.val(this._selected_emoji),this._$status_emoji_picker.find(".current_status_empty_emoji").toggleClass("hidden",!!this._selected_emoji),this._$status_emoji_picker.find(".current_status_emoji").html(TS.format.formatCurrentStatus(this._selected_emoji,void 0,{stop_animations:!0,transform_missing_emoji:!0,ignore_emoji_mode_pref:"as_text"===TS.model.prefs.emoji_mode}))},_startTabComplete:function(){var t=this._$input,i=t.tab_complete_ui.bind(t,{id:"current_status_input_tab_complete_ui",min_width:e}),s={complete_emoji:!0,complete_members:!1,ui_initer:i,onComplete:this.onTabComplete};this._$input.TS_tabComplete(s)},_onCancel:function(){this._has_form_context||(this._maybeRemoveBodyClickHandler(),this._restoreCurrentStatus(),TS.utility.contenteditable.blur(this._$input),this._maybeHidePresetsMenu(),_.isFunction(this._onEscape)&&this._onEscape(this._getOriginalStatus()))},_onFocus:function(t){(!this.isEdited()||this._getSelectedPresetIndex()>-1||!this.hasText()&&!this._selected_emoji)&&this._maybeShowPresetsMenu(t),this._maybeAddBodyClickHandler()},_onBodyClick:function(t){TS.ui.react_emoji_menu.is_showing||$.contains(this._$container.get(0),t.target)||(TS.boot_data.feature_texty_takes_over||!this._$input.tab_complete_ui("isShowing")&&!this._$input.tab_complete_ui("wasJustHidden"))&&this._onCancel()},_onKeydown:function(t){TS.boot_data.feature_texty_takes_over?t.which===TS.utility.keymap.enter?t.stopPropagation():t.which===TS.utility.keymap.tab?t.stopPropagation():t.which===TS.utility.keymap.esc&&(t.stopPropagation(),t.preventDefault()):TS.ui.react_emoji_menu.is_showing||(t.which===TS.utility.keymap.enter&&!this._$input.tab_complete_ui("isShowing")&&this.isSaveable()?(t.stopPropagation(),this._editCurrentStatus()):t.which===TS.utility.keymap.tab&&this._$input.tab_complete_ui("isShowing")?t.stopPropagation():t.which===TS.utility.keymap.esc&&(t.stopPropagation(),t.preventDefault(),this._$input.tab_complete_ui("isShowing")||this._onCancel()))},_onKeyup:function(t){[TS.utility.keymap.enter,TS.utility.keymap.esc,TS.utility.keymap.tab].indexOf(t.which)>-1||(this._toggleStatusClearIcon(),this._toggleActionButtons(),this.isEdited()?this._maybeHidePresetsMenu():this._maybeShowPresetsMenu(t))},_maybeShowPresetsMenu:function(t){this._has_presets_menu&&(TS.menu.startWithList(t,this._$presets_list,{onClick:this._presetChosen,close_on_click:!0,ignore_bounds:!0,attach_to_target_at_full_width:!0,keep_menu_open_if_target_clicked_again:!0}),TS.kb_nav.setAllowHighlightWithoutBlurringInput(!0))},_maybeHidePresetsMenu:function(){this._has_presets_menu&&TS.model.menu_is_showing&&TS.menu.end()},_maybeAddBodyClickHandler:function(){!this._has_form_context&&this._has_presets_menu&&TS.utility.rAF(function(){$("body").on("click.ui_current_status_input",this._onBodyClick)}.bind(this))},_maybeRemoveBodyClickHandler:function(){!this._has_form_context&&this._has_presets_menu&&$(document.body).off(".ui_current_status_input")},_maybeGetCanonicalStatus:function(t){return TS.boot_data.feature_localization&&TS.i18n.locale()!==TS.i18n.DEFAULT_LOCALE?TSFEmoji.translateEmojiStringToCanonical(t,TS.i18n.locale()):t},_getLocalizedStatus:function(t){return TS.boot_data.feature_localization&&TS.i18n.locale()!==TS.i18n.DEFAULT_LOCALE?TSFEmoji.translateEmojiStringToLocal(t,TS.i18n.locale()):t},_openEmojiPicker:function(t){var e=$(t.target).closest(".current_status_emoji_picker").dimensions_rect(),n=!this._has_presets_menu;TS.ui.react_emoji_menu.start({e:t,callback:this.onEmojiSelected,position:n?"bottom-left":"top-left",offset_y:n?s:i,target_bounds:e})},_toggleActionButtons:function(){this._$action_buttons.toggleClass("invisible",!this.isSaveable()||!this.hasText()&&!this._selected_emoji)},_toggleStatusClearIcon:function(){this._$status_clear_icon_wrap.toggleClass("hidden",!this._selected_emoji&&!this.hasText())},_presetChosen:function(t){var e=$(t.target).closest(".current_status_preset_option"),i=e.data("text")||"",s=e.data("emoji")||"";TS.utility.contenteditable.value(this._$input,TS.emoji.maybeGetLocalizedEmojiString(TS.format.unFormatMsg(i))),this._selectEmoji(s),this._toggleStatusClearIcon(),this._editCurrentStatus()},clearCurrentStatus:function(){TS.utility.contenteditable.clear(this._$input),TS.ui.validation.validate(this._$input),this._selectEmoji(""),this._toggleStatusClearIcon(),this._toggleActionButtons(),this._editCurrentStatus()},clogStatusChange:function(e,i,s){var n={custom_status_set_origin:s};if(!e&&!i)return n.custom_status="UNKNOWN",void TS.clog.track("CUSTOM_STATUS_CLEAR",n);var _=this._getSelectedPresetIndex(e,i);n.custom_status=_>-1?TS.model.team.prefs.uses_customized_custom_status_presets?"ADMIN_PRESET":t[_]:"USER_DEFINED",n.custom_status_text=e,n.custom_status_emoji=i,TS.clog.track("CUSTOM_STATUS_SET",n)},clogPresetChange:function(t,e){TS.clog.track("CUSTOM_STATUS_ADMIN_PRESET_SET",{custom_status_text:t,custom_status_emoji:e,custom_status_preset:"ADMIN_PRESET_"+(this._preset_index+1)})},_getSelectedPresetIndex:function(t,e){_.isUndefined(t)&&(t=this.getEscapedInputText()),_.isUndefined(e)&&(e=this._selected_emoji);var i=TS.team.getTeamCustomStatusPresets(),s=_.findIndex(i,function(e){return e.text===t}),n=_.findIndex(i,function(t){return t.emoji===e});return s>-1&&s===n?s:-1},_restoreCurrentStatus:function(){var t=this._getOriginalStatus();TS.utility.contenteditable.value(this._$input,TS.emoji.maybeGetLocalizedEmojiString(TS.format.unFormatMsg(t.text))),TS.ui.validation.validate(this._$input),this._selectEmoji(t.emoji),this._toggleStatusClearIcon(),this._toggleActionButtons()},_editCurrentStatus:function(){if(this._has_form_context)return Promise.resolve();if(!TS.ui.validation.validate(this._$input,{quiet:!0,fast:!0}))return TS.ui.validation.validate(this._$input),Promise.resolve();if(!this.isSaveable())return Promise.resolve();this._maybeRemoveBodyClickHandler();var t,e=TS.emoji.maybeGetCanonicalEmojiString(TS.utility.contenteditable.value(this._$input).replace(/\t/g," ").trim()),i=this.getEscapedInputText(),s=this._selected_emoji||e&&TS.model.team.prefs.custom_status_default_emoji;this._has_presets_menu?t="FLEXPANE_PROFILE":this._has_form_context||(t="TEAM_MENU"),TS.boot_data.feature_texty_takes_over||this._$input.val("").val(TS.emoji.maybeGetLocalizedEmojiString(TS.format.unFormatMsg(i)));var n;if(this._is_preset_editor)n=new Promise(function(t,i){return TS.prefs.setTeamPrefByAPI({custom_status_presets:this._getUpdatedPresets(e,this._selected_emoji)},i,["uses_customized_custom_status_presets"]).then(t)}.bind(this));else{var o={profile:JSON.stringify({status_text:e,status_emoji:this._selected_emoji})};n=TS.api.call("users.profile.set",o)}return n.then(function(){this._is_preset_editor?this.clogPresetChange(i,s):this.clogStatusChange(i,s,t)}.bind(this),function(t){return _.isFunction(this._onError)&&this._onError(this._getOriginalStatus()),t&&t.data&&"ratelimited"===t.data.error?TS.generic_dialog.alert(TS.i18n.t("You’re changing your status too often! You might have better luck if you try again in a few minutes.","current_status")()):TS.generic_dialog.alert(TS.i18n.t("Sorry! Something went wrong. Please try again.","current_status")()),this._$input&&this._restoreCurrentStatus(),t}.bind(this)),TS.ui.inline_saver.show({target:this._$inline_saver,promise:n}),_.isFunction(this._onSave)&&this._onSave({text:i,emoji:s}),n},_startTexty:function(){var t=this._editCurrentStatus,e=this._onCancel,i=this._onFocus,s=this._$input,n=this._is_preset_editor?TS.i18n.t("e.g. Gone to lunch","current_status")():TS.i18n.t("What’s your status?","current_status")();TS.utility.contenteditable.create(s,{modules:{tabcomplete:{completers:[TS.tabcomplete.emoji],positionMenu:function(t){t.style.width=s.outerWidth()+"px",t.style.minWidth=0,TS.tabcomplete.positionUIRelativeToInput(t,s)}}},singleLineInput:!0,placeholder:n,onFocus:function(){i(jQuery.Event("focus",{target:s,currentTarget:s}))},onEnter:function(){return t(),!1},onEscape:function(){return e(),!1},onTextChange:function(){TS.ui.validation.validate(s)}}),TS.utility.contenteditable.value(s,TS.emoji.maybeGetLocalizedEmojiString(TS.format.unFormatMsg(this._getOriginalStatus().text))),TS.utility.contenteditable.enable(s)},_getUpdatedPresets:function(t,e){var i=[],s=TS.model.team.prefs.custom_status_presets,n=s.slice(0,this._preset_index),_=[e,t],o=s.slice(this._preset_index+1);return i=n,i.push(_),i.concat(o)}});var t=["IN_A_MEETING","COMMUTING","OUT_SICK","VACATIONING","WORKING_REMOTELY"],e=400,i=-5,s=5}()}},[3004]);