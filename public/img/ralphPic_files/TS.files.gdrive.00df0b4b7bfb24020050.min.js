webpackJsonp([255],{2745:function(e,t){!function(){"use strict";TS.registerModule("files.gdrive",{onStart:function(){TS.client&&TS.files.team_file_shared_sig.add(g)},openPickerWindow:function(){var t=null;return new Promise(function(n,a){TS.utility.window.open({url:e,try_window_open_in_ssb:!0,height:r})||a(new Error("could not open window")),t=l(n,a),window.addEventListener("message",t),i&&a("Promise already made"),i=!0}).then(function(e){return i=!1,d(e.chosen_files,TS.shared.getActiveModelOb())}).catch(function(e){if("Promise already made"!==e){var t=a,n=TS.shared.getActiveModelOb();TS.error(e),"unidentified_external_url"!==e.data.error&&"file_type_has_no_handler"!==e.data.error||!e.args.link||(t=TS.i18n.t("We don’t currently support importing that type of Google Drive file, but we included the link so that others can access it.","files")(),S(n.id,e.args.link)),"filename_too_long"===e.data.error&&(t=o),TS.client.ui.addEphemeralBotMsg({text:t,ephemeral_type:"file_type_has_no_handler",slackbot_feels:"sad_surprise"}),i=!1}}).finally(function(){window.removeEventListener("message",t)})},createAndShare:function(e){return f(e).then(function(t){TS.files.gdrive.create(e,t)}).catch(function(){TS.menu.file.onGDriveCreateComplete(!1)})},create:function(e,t){if(t&&t.channel){var r=TS.channels.getChannelById(t.channel);r&&r.name?TS.channels.join(r.name,!1):TS.ims.getImByMemberId(t.channel)?TS.ims.startImByMemberId(t.channel):TS.mpims.getMpimById(t.channel)?TS.mpims.displayMpim({id:t.channel}):TS.groups.getGroupById(t.channel)?TS.groups.displayGroup({id:t.channel}):TS.error("no valid shared channel/im/mpim/group to display")}return TS.api.call("files.createExternal",{service_stub:"gdrive",mime_type:n+"."+e,filename:t.title||"",open_edit:!!t.channel}).then(function(e){TS.utility.window.alwaysOpenInBrowser(e.data.url),t&&t.channel&&p(e.data.url,t.channel,t.comment),TS.menu.file.onGDriveCreateComplete(!0,e)}).catch(function(n){TS.menu.file.onGDriveCreateComplete(!1);var r=a;if("use_auth_url"===n.data.error)return m(e,t);"filename_too_long"===n.data.error&&(r=o),TS.error(n),TS.client.ui.addEphemeralBotMsg({text:r,ephemeral_type:"unhandled_gdrive_create",slackbot_feels:"sad_surprise"})})}});var e=TS.boot_data.team_url+"files/import/gdrive",t=TS.boot_data.team_url+"files/create/gdrive/auth",n="application/vnd.google-apps",r=675,i=!1,a=TS.i18n.t("Darn, that didn’t work. Try again or <https://my.slack.com/help/requests/new|contact us> if it’s still not working.","files")(),o=TS.i18n.t("Sorry! The name of that file is too long for us to handle. Please try importing a file with a shorter filename.","files")(),l=function(e,t){return c({resolve:e,reject:t,method:"gdrive_picker"})},s=function(e,t){return c({resolve:e,reject:t,method:"google_auth"})},c=function(e){return function(t){t.data.method===e.method&&(t.data.ok?e.resolve(t.data):e.reject(new Error(e.method+" not ok")))}},d=function(e,t){var n=e.map(function(e){return u(e,t)});return Promise.all(n)},u=function(e,t){return TS.api.call("files.uploadExternal",{channels:t.id,link:e.url}).then(function(e){t.user&&TS.ims.getImByMemberId(t.user)&&TS.model.team.enterprise_id&&S(t.id,e.data.file.url_private,!0,!0)})},m=function(e,n){var i=null;return new Promise(function(e,n){TS.utility.window.open({url:t,try_window_open_in_ssb:!0,height:r})||n(new Error("could not open window")),i=s(e,n),window.addEventListener("message",i)}).then(function(){return TS.files.gdrive.create(e,n)}).catch(function(e){TS.error(e)}).finally(function(){window.removeEventListener("message",i)})},f=function(e){return new Promise(function(t,r){var i={type:n+e},a=TS.templates.builders.buildFileSharingControls(i,!1,!1,!0,null),o=TS.i18n.t("Create a Google {gdrive_type}","files")({gdrive_type:_.capitalize(e)});TS.generic_dialog.start({title:o,body:TS.templates.gdrive_create_dialog({sharing_html:new Handlebars.SafeString(a)}),show_cancel_button:!0,esc_for_ok:!1,fullscreen:!1,go_button_text:TS.i18n.t("Create","files")(),type:"overflow_visible",onGo:function(){t(h())},onCancel:r}),$("#share_cb").removeAttr("checked"),TS.ui.file_share.bindFileShareDropdowns(),TS.ui.file_share.bindFileShareShareToggle(),TS.ui.file_share.bindFileShareCommentField(),TS.ui.comments.bindInput($("#file_comment_textarea"),function(){t(h)})})},h=function(){return{title:_.trim($("#document_title").val())||TS.i18n.t("Untitled","files")(),comment:_.trim(TS.utility.contenteditable.value($("#file_comment_textarea"))),channel:!!$("#share_cb").is(":checked")&&$("#share_model_ob_id").val()}},p=function(e,t,n){var r=!1;return TS.ims.getImByMemberId(t)&&(r=!0),TS.api.call("files.uploadExternal",{link:e,channels:r?"":t}).then(function(e){r&&S(t,e.data.file.url_private,!0,!0),n&&TS.api.call("files.comments.add",{file:e.data.file.id,comment:n,channel:t})}).catch(function(e){TS.error(e),TS.client.ui.addEphemeralBotMsg({text:TS.i18n.t("Oh no! I couldn’t import your newly created file","files")(),ephemeral_type:"gdrive_share_file_error",slackbot_feels:"sad_surprise"})})},S=function(e,t,n,r){TS.api.call("chat.postMessage",{channel:e,text:t,unfurl_links:n||!1,unfurl_media:r||!1}).catch(function(e){TS.error(e)})},g=function(e){"gdrive"===_.get(e,"external_type")&&_.get(e,"user")===TS.model.user.id&&TS.model.team.prefs.gdrive_enabled_team&&(TS.model.prefs.seen_gdrive_coachmark||(TS.coachmark.start(TS.coachmarks.coachmarks.gdrive),TS.model.prefs.seen_gdrive_coachmark=!0,TS.prefs.setPrefByAPI({name:"seen_gdrive_coachmark",value:!0})))}}()}},[2745]);